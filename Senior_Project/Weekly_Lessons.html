<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="index.CSS">
    <link rel="stylesheet" href="login.CSS">
    <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.js"   integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="   crossorigin="anonymous"></script>
  </head>
  <body style="background-color:#59656F;">
  <Nav>
    <a class="title" id="title" >Stephen Labay Baseball Lessons</a>
      <ul class ="nav-links">
       <li>
            <a href="index.html">Home</a>
        </li>
        
        <li>
            <a href="Schedule_Lesson.html">Schedule a Lesson</a>
        </li>
        
        <li>
          <a href="Weekly_Lessons.html">Weekly Lessons</a>
        </li>
        
       <li>
          <div class="dropdown">
            <button onclick="myFunction()" class="dropbtn">Former Players</button>
              <div id="myDropdown" class="dropdown-content">
                <a href="Reviews.html">Reviews</a>
                <a href="Notable_Players.html">Notable Alumni</a>
              </div>
            </div>
         </li>
          
        <li class="logged-out" style="display: none;">
          <a href="#" id="loginbtn" class="modal-trigger" data-target="modal-login">login</a>
         </li>
             
        <li class="logged-in" style="display: none;"> 
          <a href="#" id="logout">logout</a> 
           </li>
         
        </ul>
        
    </Nav>

  <div id="modal-login" class="modal">
    <div class="modal-content">
     <span class="close">&times;</span>
       <h4>Login</h4>
       <form id="login-form">
         <div class="input-field">
          <label for="login-email">Email Address</label>
          <input type="email" id="login-email" required />
         </div>
         <div class="input-field">
          <label for="login-password">Your Password</label>
          <input type="password" id="login-password" required />
         </div>
         <button id="btnSave" type="submit" class="btn btn-primary" data-dismiss="modal">Login</button>
       </form>
     </div>
   </div>
   
  
<!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <input type="text" id="NewDesc" placeholder="Description" required />
         </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" onclick="updateFirebase()" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>
  
  
 
  <div class="col-lg-12">
    <div class="container" id="container">
           <!-----------post pic starts -------------->
      <div class="jumbotron bg-dark logged-in" style="margin-top: 15px;">
        <script>
          var counter = 0;
        </script>
        <div class="container text-center">
          <form id="main-form">
            <div class="form-group">
              <textarea name="text" rows="2" placeholder="caption" class="form-control" id="Weekly-desc"></textarea>
                <div class="invalid-feedback">
                   please write description
                  </div>
              </div>
              <div class="form-group">
                <input type="file" class="form-control" id="Weekly-image" />
                  <div class="invalid-feedback">
                    please choose valid pic
                    </div>
                </div>
              <div class="form-group">
                <img id="selected-image" width="500" height="150" src="#" />

                </div>
              <div class="form-group">
               <div class="progress bg-secondary">
                 <div class="progress-bar bg-success" id="upload-progress" style="width: 0%;"></div>
                  </div>

              </div>
                <div class="form-group">
                  <button id="save-blog" type="button" style="width: 150px; height: 60px;" class="btn btn-light bg-light text-dark">Submit</button>
                  </div>
            </form>
                   <div id="result">

                   </div>

            </div>
          </div>

               <!---------------- Post pic ends----------------- -->

               <!-- -------------After post pic------------  -->
               
               <br><br>
               <div class="text-center text-light">
                 <h3>Weekly Lessons</h3>
               </div>

                <hr>
                <br>

                <div class="row container-fluid bg-3" class="imgContainer">
                  <div id="blogs">
                    
                  </div>
                  
           

                  
                  

                 </div>

                <br>


               <!-- -----------after post pic area ends------------------ -->

               <!--------------- validation and post pics----------------- -->
                
               <!--------------- validation and post pics ends here----------------- -->

        </div>
      </div>
   </div>
   

  <!-- The core Firebase JS SDK is always required and must be listed first -->
  
  <!-- This line below loads everything -->
  <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase.js"></script>
  
  <!-- <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-auth.js"></script> -->
  <!-- <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-firestore.js"></script> -->

  <!-- TODO: Add SDKs for Firebase products that you want to use
      https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.8.1/firebase-analytics.js"></script>

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyDBkICQCt53H1_cPbigFC_BuM8nFlYdQS8",
      authDomain: "baseball-lessons-a5e57.firebaseapp.com",
      databaseURL: "https://baseball-lessons-a5e57.firebaseio.com",
      projectId: "baseball-lessons-a5e57",
      storageBucket: "baseball-lessons-a5e57.appspot.com",
      messagingSenderId: "304091917830",
      appId: "1:304091917830:web:8a039bc3327615416add87",
      measurementId: "G-L3PJ9XHT64"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  
    //make auth and firestore referneces
    const auth = firebase.auth();
    const db = firebase.firestore();
  
  </script>

  <script>

    // var validImagetypes = ["image/gif", "image/jpeg", "image/png", "video/MOV"];
    $("#selected-image").hide();

    
    //Preview Image in form
    function previewImage(image_pic){
      if(image_pic.files && image_pic.files[0]){
        
        var reader = new FileReader();
        reader.onload = function(e){
            $("#selected-image").attr('src', e.target.result);
            $("#selected-image").fadeIn();

        }
        reader.readAsDataURL(image_pic.files[0]);

      }

        
    }

    $("#Weekly-image").change(function(){
        previewImage(this);
    });

    $("#save-blog").click(function(){
        $("#Weekly-desc").removeClass("is-invalid");
        $("#Weekly-image").removeClass("is-invalid");

        var desc = $("#Weekly-desc").val();
        var picture = $("#Weekly-image").prop("files")[0];

        if(!desc){
            $("#Weekly-desc").addClass("is-invalid");
            return;
        }

        if(picture == null){
            $("#Weekly-image").addClass("is-invalid");
            return;
        }

        // if($.inArray(picture["type"], validImagetypes)<0){
        //     $("#Weekly-image").addClass("is-invalid");
        //     return;
        // }


        // upload and save to firebase storage and firebase DB
        var databaseRef = firebase.database().ref().child("Weekly_Vids");

        databaseRef.once("value").then(function(snapshot){
        
          var name = picture["name"];
          var dateStr = new Date().getTime();
          var fileCompleteName = name + "_" + dateStr;

          var storageRef = firebase.storage().ref("Pics");
          var blogStorageRef = storageRef.child(fileCompleteName);

          var uploadTask = blogStorageRef.put(picture);

          uploadTask.on("state_changed", 
            
            function progress(snapshot)
            {
            var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            
            $("#upload-progress").html(Math.round(percentage) + "%");
            $("#upload-progress").attr("style", "width:" + percentage + "%");

            
          },
          function error(error){

          },
          function complete(){
            uploadTask.snapshot.ref.getDownloadURL().then(function(downloadUrl){
              var time = new Date();

              var picData = {
                
                "image": downloadUrl,
                "name": fileCompleteName,
                "desc": desc,
                "counter": 5000 - counter
                
              };

              var newPostRef = databaseRef.push();

              newPostRef.set(picData, function(err){
                if(err){
                  
                  $("#result").attr("class", "alert alert-danger");
                  $("#result").html(err.message);

                }
                else{
                  
                  $("#result").attr("class", "alert alert-danger");
                  $("#result").html("Image has been posted");

                  window.open("", "_self");

                }
                resetForm();
             
              });
            
            });
          
          }
        
        );

      });
    // upload and save to firebase storage and firebase DB

    });

    
    //Resets upload form
    function resetForm(){
      
      $("#main-form")[0].reset();
      $("#selected-image").fadeOut();
      $("#upload-progress").html("done");

    }
    
    //***************** Retreive and display data from Firebase ***********

    var dbPics = firebase.database().ref().child("Weekly_Vids").orderByChild("counter");

    dbPics.on("value", function(pics){
      if(pics.exists()){
        var picsHtml = "";
        
        
        pics.forEach(function(singlePic){
           counter = counter + 1;
            
            picsHtml += "<div> <img class='center-block' width= '800px' height = '500px' src = '";
              picsHtml += singlePic.val().image;
            picsHtml += "'/></div> <br>";
            
            picsHtml += "<div style = 'text-center: justify; color: white;'>";
              picsHtml += singlePic.val().desc;
            picsHtml += "</div>";

            picsHtml += "<div class = 'form-group' style = 'text-center: justify; color: black;'>";
              picsHtml += "<button class='btn btn-primary logged-in' data-toggle='modal' data-target='#exampleModal'>Update Description</button>";
              picsHtml += "<button class='btn btn-danger logged-in' onclick=deleteImage('"+singlePic.key+"')>Delete</button>";
            picsHtml += "</div> <br>";

          picsHtml += "</div>";
        });

        $("#blogs").html(picsHtml);
        setupUI(firebase.auth().currentUser);

      }


    });

    
    //delete from firebase
    function deleteImage(key){
      var deleteRef = firebase.database().ref().child("Weekly_Vids").child(key);

      return deleteRef.remove()
      .then(function() {
        console.log("Success");
      })
      
      .catch(function() {
        console.log("Fail");
      });
    }

    
    //Update Firebase
    function updateFirebase(){
      const fb = firebase.database().ref('Weekly_Vids/');
      var New_Desc = document.getElementById('NewDesc').value;
      var Old_Desc = document.getElementById('Weekly-desc').value;
      
      fb.update({desc: New_Desc});
      
      // data = {New_Desc};

      // fb.child('Notable_Images/').update(data);


    }

    //***************** Ends here -- Retreive and display data from Firebase ***********

  </script>

 
  <script src="scripts/dropdown.js"></script>
  <script src="scripts/index.js"></script>
  <script src="scripts/auth.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>
